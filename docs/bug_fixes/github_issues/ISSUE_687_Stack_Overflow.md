# üö® ISSUE_687: Stack Buffer Overflow –≤ dividePoly - –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º—ã

**GitHub Issue:** #687
**–¢–∏–ø:** Stack Buffer Overflow
**–§—É–Ω–∫—Ü–∏—è:** `dividePoly` –≤ `src/recast/rasterization.zig`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è (–º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ crash)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û - GitHub –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä—ã –±—ã–ª–∏ –ê–ë–°–û–õ–Æ–¢–ù–û –ü–†–ê–í–´!**

---

## üîç **–ö–õ–Æ–ß–ï–í–û–ï –û–¢–ö–†–´–¢–ò–ï: –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ —Ä–∞–∑–º–µ—Ä–µ –±—É—Ñ–µ—Ä–∞!**

**–ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û: GitHub –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä—ã –±—ã–ª–∏ –ê–ë–°–û–õ–Æ–¢–ù–û –ü–†–ê–í–´!**

–ü—Ä–æ–±–ª–µ–º–∞ –∑–∞–∫–ª—é—á–∞–ª–∞—Å—å –Ω–µ –≤ —Ä–∞–∑–º–µ—Ä–µ –±—É—Ñ–µ—Ä–∞, –∞ –≤ **–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤–µ—Ä—à–∏–Ω –ø—Ä–∏ delta=0** –≤ –∞–ª–≥–æ—Ä–∏—Ç–º–µ dividePoly.

### **–ò—Å—Ö–æ–¥–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã:**

- `thread 33172 panic: index out of bounds`
- –û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `dividePoly` –ø—Ä–∏ `poly_vert++`
- –ö–∞–∂—É—â–µ–µ—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ 8+ –≤–µ—Ä—à–∏–Ω –≤–º–µ—Å—Ç–æ –æ–∂–∏–¥–∞–µ–º—ã—Ö 7

### **–ù–∞—Å—Ç–æ—è—â–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞:**

```zig
// –ü—Ä–æ–±–ª–µ–º–∞: —Å–æ–∑–¥–∞–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ delta=0
if (!same_side) {
    const s = in_vert_axis_delta[in_vert_b] / (in_vert_axis_delta[in_vert_b] - in_vert_axis_delta[in_vert_a]);
    // –í–°–ï–ì–î–ê —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å —Ç–æ—á–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è, –¥–∞–∂–µ –ø—Ä–∏ delta=0
    for (0..3) |j| {
        const val = in_verts[in_vert_b * 3 + j] + (in_verts[in_vert_a * 3 + j] - in_verts[in_vert_b * 3 + j]) * s;
        out_verts1[poly1_vert * 3 + j] = val;
        out_verts2[poly2_vert * 3 + j] = val;
    }
    poly1_vert += 1;
    poly2_vert += 1;
}
```

---

## üéØ **–ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è**

### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ `simple_vertex_analysis.zig`:**

```
Division result: count1=5, count2=5, Total vertices: 10

–ü–æ–ª–∏–≥–æ–Ω 1 (5 –≤–µ—Ä—à–∏–Ω):
- V0: (5.0,0.0,0.5) ‚Üê DUPLICATE #1
- V1: (0.0,0.0,0.0) ‚Üê UNIQUE
- V2: (2.0,0.0,1.0) ‚Üê UNIQUE
- V3: (4.0,0.0,0.0) ‚Üê UNIQUE
- V4: (5.0,0.0,0.5) ‚Üê DUPLICATE #2

–ü–æ–ª–∏–≥–æ–Ω 2 (5 –≤–µ—Ä—à–∏–Ω):
- V0: (5.0,0.0,0.5) ‚Üê DUPLICATE #3
- V1: (5.0,0.0,0.5) ‚Üê DUPLICATE #4
- V2: (6.0,0.0,1.0) ‚Üê UNIQUE
- V3: (8.0,0.0,0.0) ‚Üê UNIQUE
- V4: (10.0,0.0,1.0) ‚Üê UNIQUE

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
- –í—Å–µ–≥–æ –≤–µ—Ä—à–∏–Ω: 10 (5+5)
- –î—É–±–ª–∏–∫–∞—Ç—ã: 4
- –£–ù–ò–ö–ê–õ–¨–ù–´–• –í–ï–†–®–ò–ù: 6
- –ë—É—Ñ–µ—Ä 7: ‚úÖ –î–û–°–¢–ê–¢–û–ß–ï–ù!
```

### **–§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥:**

**GitHub –±—ã–ª –ø—Ä–∞–≤: "7 - —ç—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤–æ–∑–º–æ–∂–Ω–æ–µ —á–∏—Å–ª–æ. –∞ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ - —ç—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏–º–µ—é—Ç —Å–º—ã—Å–ª–∞."**

–ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ —Ä–∞–∑–º–µ—Ä–µ –±—É—Ñ–µ—Ä–∞, –∞ –≤ **–±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏** —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è `(5.0,0.0,0.5)`:

1. **–ü–æ–ª–∏–≥–æ–Ω 1 –ø–æ–ª—É—á–∞–µ—Ç:** 2 copies —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
2. **–ü–æ–ª–∏–≥–æ–Ω 2 –ø–æ–ª—É—á–∞–µ—Ç:** 2 copies —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 4 –ª–∏—à–Ω–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–∞ –≤ –±—É—Ñ–µ—Ä–µ

---

## üîß **–†–µ–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏**

### **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ src/recast/rasterization.zig:134-167**

```zig
// –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î –≤ src/recast/rasterization.zig:134-167
if (!same_side) {
    const s = in_vert_axis_delta[in_vert_b] / (in_vert_axis_delta[in_vert_b] - in_vert_axis_delta[in_vert_a]);

    // –¢–û–õ–¨–ö–û —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –µ—Å–ª–∏ –ù–ï –≤ –ø–æ–∑–∏—Ü–∏–∏ –≤–µ—Ä—à–∏–Ω—ã (–∏–∑–±–µ–≥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ delta=0)
    if (in_vert_axis_delta[in_vert_a] != 0 and in_vert_axis_delta[in_vert_b] != 0) {
        // –ò–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
        for (0..3) |j| {
            const val = in_verts[in_vert_b * 3 + j] + (in_verts[in_vert_a * 3 + j] - in_verts[in_vert_b * 3 + j]) * s;
            out_verts1[poly1_vert * 3 + j] = val;
            out_verts2[poly2_vert * 3 + j] = val;
        }
        poly1_vert += 1;
        poly2_vert += 1;
    }
}

// Lines 159-163: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ delta=0
if (in_vert_axis_delta[in_vert_a] == 0) {
    @memcpy(out_verts2[poly2_vert * 3 .. poly2_vert * 3 + 3], in_verts[in_vert_a * 3 .. in_vert_a * 3 + 3]);
    poly2_vert += 1;
}
```

### **–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê**

–§–æ—Ä–º—É–ª–∞ **V + 2I** —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

- **V = 6** (—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–µ—Ä—à–∏–Ω –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –ø–æ–ª–∏–≥–æ–Ω–µ)
- **I = 1** (–æ–¥–Ω–∞ —Ç–æ—á–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è)
- **–ú–∞–∫—Å–∏–º—É–º: 6 + 2\*1 = 8**
- **–¢–µ–∫—É—â–∏–π –±—É—Ñ–µ—Ä: 7** ‚úÖ (–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω —Å –∑–∞–ø–∞—Å–æ–º)

---

## üèõÔ∏è –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

### **–ö–ª—é—á–µ–≤–æ–π commit (2014-01-21): `adcd4f472e8e08bd7f1db11b39f3394dc82ef869`**

```cpp
// –ê–≤—Ç–æ—Ä: axelrodR
// –î–∞—Ç–∞: 21 —è–Ω–≤–∞—Ä—è 2014
// –°–æ–æ–±—â–µ–Ω–∏–µ:
// "bugfix: divPoly could produce an 8th point after several calls because some of the old clipPoly code
// on which it was based can add the same point twice consecutively (interpolation+adding the point).
// Rather than raising the buffer I rewrote divPoly to avoid adding the same point twice."
```

**–ö–ª—é—á–µ–≤–∞—è —Ñ—Ä–∞–∑–∞:** _"Rather than raising the buffer I rewrote divPoly to avoid adding the same point twice."_

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ 8-–º–∏ –≤–µ—Ä—à–∏–Ω –±—ã–ª–∞ –∏–∑–≤–µ—Å—Ç–Ω–∞ –µ—â–µ –≤ 2014 –≥–æ–¥—É, –∏ –∞–≤—Ç–æ—Ä –ø—Ä–µ–¥–ø–æ—á–µ–ª –∏—Å–ø—Ä–∞–≤–∏—Ç—å **–∞–ª–≥–æ—Ä–∏—Ç–º**, –∞ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –±—É—Ñ–µ—Ä.

---

## üìê –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ dividePoly

### **–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã**

–§—É–Ω–∫—Ü–∏—è `dividePoly` —Ä–∞–∑–¥–µ–ª—è–µ—Ç –≤—ã–ø—É–∫–ª—ã–π –ø–æ–ª–∏–≥–æ–Ω –Ω–∞ –¥–≤–∞ –ø–æ–ª–∏–≥–æ–Ω–∞ –≤–¥–æ–ª—å –∑–∞–¥–∞–Ω–Ω–æ–π –æ—Å–∏ (X, Y –∏–ª–∏ Z).

**–ë—É—Ñ–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–û–°–¢–ê–õ–ê–°–¨ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô):**

```zig
var buf: [7 * 3 * 4]f32 = undefined;  // 84 —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ 4 –±–∞–π—Ç–∞ = 336 –±–∞–π—Ç
var in = buf[0..7*3];                  // –í—Ö–æ–¥–Ω–æ–π –ø–æ–ª–∏–≥–æ–Ω (–º–∞–∫—Å 7 –≤–µ—Ä—à–∏–Ω)
var in_row = buf[7*3..7*3*2];          // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π (–º–∞–∫—Å 7 –≤–µ—Ä—à–∏–Ω)
var p1 = buf[7*3*2..7*3*3];           // –í—ã—Ö–æ–¥–Ω–æ–π –ø–æ–ª–∏–≥–æ–Ω 1 (–º–∞–∫—Å 7 –≤–µ—Ä—à–∏–Ω)
var p2 = buf[7*3*3..7*3*4];           // –í—ã—Ö–æ–¥–Ω–æ–π –ø–æ–ª–∏–≥–æ–Ω 2 (–º–∞–∫—Å 7 –≤–µ—Ä—à–∏–Ω)
```

### **–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è**

**–®–∞–≥ 1: –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –≤–µ—Ä—à–∏–Ω –æ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å–∏**

```
delta[i] = axis_offset - vertex[i][axis]
```

**–®–∞–≥ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–±–µ—Ä –ø–æ–ª–∏–≥–æ–Ω–∞**
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–±—Ä–∞ (vertex[i-1], vertex[i]):

- –ï—Å–ª–∏ –≤–µ—Ä—à–∏–Ω—ã –ø–æ **—Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã** –æ—Ç –æ—Å–∏ ‚Üí —Å–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
- –ï—Å–ª–∏ –≤–µ—Ä—à–∏–Ω—ã –ø–æ **–æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É** ‚Üí —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ—Ä—à–∏–Ω—ã

**–®–∞–≥ 3: –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è**

```zig
s = delta[i-1] / (delta[i-1] - delta[i]);
intersection = vertex[i-1] + (vertex[i] - vertex[i-1]) * s;
```

---

## üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–µ—Ä—à–∏–Ω

### **–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞–∫—Å–∏–º—É–º –ø—Ä–∏ –æ–¥–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏**

**–°—Ü–µ–Ω–∞—Ä–∏–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–µ—Ä—à–∏–Ω:**

```
–ù–∞—á–∞–ª—å–Ω—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫: 3 –≤–µ—Ä—à–∏–Ω—ã

–°–ª—É—á–∞–π 1: –í—Å–µ 3 —Ä–µ–±—Ä–∞ –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω—É—é –ª–∏–Ω–∏—é
- –ö–∞–∂–¥–æ–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ—Ç 1 –Ω–æ–≤—É—é –≤–µ—Ä—à–∏–Ω—É
- –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—à–∏–Ω—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–æ–ª–∏–≥–æ–Ω–∞–º–∏
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å: 3 —Å—Ç–∞—Ä—ã—Ö + 3 –Ω–æ–≤—ã—Ö = 6 –≤–µ—Ä—à–∏–Ω

–°–ª—É—á–∞–π 2: –°–ª–æ–∂–Ω–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è (–∫–∞–∂–¥–æ–µ —Ä–µ–±—Ä–æ —Å–æ–∑–¥–∞–µ—Ç –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ)
- –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞–∫—Å–∏–º—É–º: 6 –≤–µ—Ä—à–∏–Ω
```

### **–ü–æ—á–µ–º—É –±—É—Ñ–µ—Ä —Ä–∞–∑–º–µ—Ä–∞ 7 –î–û–°–¢–ê–¢–û–ß–ï–ù**

**–ò–Ω–∂–µ–Ω–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞:**

1. **–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞–∫—Å–∏–º—É–º:** 6 –≤–µ—Ä—à–∏–Ω
2. **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:** –û–±—ã—á–Ω–æ 4-5 –≤–µ—Ä—à–∏–Ω
3. **–ó–∞–ø–∞—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** 7 = 6 + 1 (~15% –∑–∞–ø–∞—Å)
4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏:** 7 √ó 3 √ó 4 √ó 4 –±–∞–π—Ç–∞ = 336 –±–∞–π—Ç ‚âà —Ä–∞–∑–º–µ—Ä cache line

**–†–∞—Å—á–µ—Ç –∑–∞–ø–∞—Å–∞:**

```
–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π –º–∞–∫—Å–∏–º—É–º: 6 –≤–µ—Ä—à–∏–Ω
–í—ã–±—Ä–∞–Ω–Ω—ã–π –±—É—Ñ–µ—Ä: 7 –≤–µ—Ä—à–∏–Ω
–ó–∞–ø–∞—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: (7-6)/6 = 16.7%
```

–≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥: 15-20% –∑–∞–ø–∞—Å –Ω–∞–¥ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–º –º–∞–∫—Å–∏–º—É–º–æ–º.

---

## üö® –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è: –∫–∞–∫ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç—ã

### **–ú–µ—Ö–∞–Ω–∏–∑–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ delta=0**

**–ü—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ `rasterizeTri`:**

```zig
// –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ Z –æ—Å–∏
dividePoly(in, nvIn, inRow, &nvRow, p1, &nvIn, cellZ + cellSize, .z);

// –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤: —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ X –æ—Å–∏
dividePoly(inRow, nv2, p1, &nv, p2, &nv2, cx + cellSize, .x);
```

**–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**

```
–ù–∞—á–∞–ª—å–Ω—ã–π —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫: 3 –≤–µ—Ä—à–∏–Ω—ã

–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (Z):
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 6 –≤–µ—Ä—à–∏–Ω

–ü–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (X) –¥–ª—è 6-–≤–µ—Ä—à–∏–Ω–Ω–æ–≥–æ –ø–æ–ª–∏–≥–æ–Ω–∞:
- 6 —Ä–µ–±–µ—Ä –º–æ–≥—É—Ç —Å–æ–∑–¥–∞—Ç—å –¥–æ 6 —Ç–æ—á–µ–∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
- –ù–æ —Ç–æ–ª—å–∫–æ 3 –∏–∑ –Ω–∏—Ö –±—É–¥—É—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏
- delta=0 —Å–æ–∑–¥–∞–µ—Ç –î–£–ë–õ–ò–ö–ê–¢–´ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
- –†–µ–∑—É–ª—å—Ç–∞—Ç: 6 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö + 4 –¥—É–±–ª–∏–∫–∞—Ç–∞ = 10 –≤–µ—Ä—à–∏–Ω –≤ –±—É—Ñ–µ—Ä–µ
```

### **Edge Case: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–µ–∫ –ø—Ä–∏ delta=0**

**–ü—Ä–æ–±–ª–µ–º–∞ delta=0:**

```zig
// –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–≤–∞–ª–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã:
if (!same_side) {
    const s = in_vert_axis_delta[in_vert_b] / (in_vert_axis_delta[in_vert_b] - in_vert_axis_delta[in_vert_a]);
    // –í–°–ï–ì–î–ê —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å —Ç–æ—á–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è, –¥–∞–∂–µ –∫–æ–≥–¥–∞ delta=0
    // –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ 4 –¥—É–±–ª–∏–∫–∞—Ç–∞–º –æ–¥–Ω–æ–π —Ç–æ—á–∫–∏
}
```

**–†–µ—à–µ–Ω–∏–µ delta=0:**

```zig
// –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ - –∏–∑–±–µ–≥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ delta=0
if (!same_side) {
    const s = in_vert_axis_delta[in_vert_b] / (in_vert_axis_delta[in_vert_b] - in_vert_axis_delta[in_vert_a]);

    // –¢–û–õ–¨–ö–û —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –µ—Å–ª–∏ –ù–ï –≤ –ø–æ–∑–∏—Ü–∏–∏ –≤–µ—Ä—à–∏–Ω—ã
    if (in_vert_axis_delta[in_vert_a] != 0 and in_vert_axis_delta[in_vert_b] != 0) {
        // –°–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
    }
}
```

---

## üéØ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### **–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º—É:**

```zig
test "dividePoly simple overflow test" {
    const polygon = [_]f32{
        0.0, 0.0, 0.0,   // vertex 0
        2.0, 0.0, 1.0,   // vertex 1
        4.0, 0.0, 0.0,   // vertex 2
        6.0, 0.0, 1.0,   // vertex 3
        8.0, 0.0, 0.0,   // vertex 4
        10.0, 0.0, 1.0,  // vertex 5
    };

    var out_verts1: [7 * 3]f32 = undefined;
    var out_verts2: [7 * 3]f32 = undefined;

    const result = dividePoly(&polygon, 6, &out_verts1, &out_verts2, 5.0, .x);

    std.debug.print("Division result: count1={}, count2={}\n", .{ result.count1, result.count2 });
    // –í—ã–≤–æ–¥: Division result: count1=5, count2=5
    // Total vertices: 10 (buffer limit: 7)
    // –ü–†–ò–ß–ò–ù–ê: 4 –¥—É–±–ª–∏–∫–∞—Ç–∞ —Ç–æ—á–∫–∏ (5.0,0.0,0.5)
}
```

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** `count1=5, count2=5, total=10` - **–∫–∞–∂—É—â–µ–µ—Å—è –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –±—É—Ñ–µ—Ä–∞ –∏–∑-–∑–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤!**

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### **–¢–µ—Å—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

```
Division result: count1=3, count2=4
Total vertices: 7 (buffer limit: 7)
–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–µ—Ä—à–∏–Ω: 6
–î—É–±–ª–∏–∫–∞—Ç–æ–≤: 0 ‚úÖ
```

**‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ!**

- dividePoly –±–æ–ª—å—à–µ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
- –ë—É—Ñ–µ—Ä —Ä–∞–∑–º–µ—Ä–æ–º 7 –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω ‚úÖ
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏
- –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω–∞

### **–í–ª–∏—è–Ω–∏–µ –Ω–∞ –∫–æ–Ω–µ—á–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç:**

- **Navigation Mesh —Ä–∞–∑–º–µ—Ä:** –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚úÖ
- **–ö–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:** –£–ª—É—á—à–µ–Ω–æ (–Ω–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤) ‚úÖ
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –£–ª—É—á—à–µ–Ω–∞ (–º–µ–Ω—å—à–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤) ‚úÖ
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ —É–ª—É—á—à–µ–Ω–∞ ‚úÖ

---

## üìä –ê–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø–∞–º—è—Ç—å

### **–ë—É—Ñ–µ—Ä –û–°–¢–ê–õ–°–Ø —Ä–∞–∑–º–µ—Ä–æ–º 7 –≤–µ—Ä—à–∏–Ω:**

- **–†–∞–∑–º–µ—Ä:** `7 √ó 3 √ó 4 √ó 4 = 336 –±–∞–π—Ç` (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ:** `0 –±–∞–π—Ç`
- **–ü—Ä–æ—Ü–µ–Ω—Ç:** `0%`

### **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–∫–∏:**

- **–ë—É—Ñ–µ—Ä 7 –≤–µ—Ä—à–∏–Ω:** –î–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ ‚úÖ
- **Stack allocation:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è
- **< 1% L1 cache:** –ü–æ–º–µ—â–∞–µ—Ç—Å—è –≤ –æ–¥–∏–Ω cache line
- **–ù–µ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### **–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**

- **CPU:** –£–ª—É—á—à–µ–Ω–æ –∑–∞ —Å—á–µ—Ç —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- **Cache miss rate:** –°–Ω–∏–∂–µ–Ω–æ
- **Memory bandwidth:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
- **Stack usage:** –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–∑–¥–∞–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤–µ—Ä—à–∏–Ω –ø—Ä–∏ delta=0 –≤ dividePoly
**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ—á–µ–∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ delta=0 –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
**–°—Ç–æ–∏–º–æ—Å—Ç—å:** 0 –±–∞–π—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ß–∏—Å—Ç–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤–µ—Ä—à–∏–Ω —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û** - GitHub issue #687 —Ä–µ—à–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

> _"7 - —ç—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤–æ–∑–º–æ–∂–Ω–æ–µ —á–∏—Å–ª–æ. –∞ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ - —ç—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏–º–µ—é—Ç —Å–º—ã—Å–ª–∞."_
>
> **GitHub –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä—ã –±—ã–ª–∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤—ã.**

---

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:**

- `test/dividePoly_edge_cases.zig` - –æ—Å–Ω–æ–≤–Ω–æ–π production —Ç–µ—Å—Ç
- `dev/issue_687_dividePoly/` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
