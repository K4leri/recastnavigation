# Исправление Issue #793: OverlapSlabs Height Threshold Bug

## Описание проблемы

**Issue #793** в оригинальной библиотеке RecastNavigation указывает на ошибку в функции `overlapSlabs`, где используется некорректное значение порога высоты для соединения полигонов.

### Суть проблемы

- **Функция:** `overlapSlabs` в `DetourNavMesh.cpp`
- **Проблема:** Использование `dtSqr(py*2)` вместо `dtSqr(py)`
- **Последствия:** Порог высоты увеличен в 4 раза, что позволяет соединения на недостижимой высоте

### Математическое обоснование

```
walkableClimb = 1.8м (максимальная высота для агента)

❌ Неправильно (оригинальный C++ код):
   threshold = (1.8 * 2)² = 12.96
   Позволяет соединения на высоте до 3.6м

✅ Правильно (исправленный Zig код):
   threshold = 1.8² = 3.24
   Позволяет соединения только на высоте до 1.8м
```

## Исправление в Zig-реализации

### Файл: `src/detour/navmesh.zig`

**Строка 451 - ДО:**
```zig
const thr = py * py * 4.0;  // ОШИБКА: py*2
```

**Строка 451 - ПОСЛЕ:**
```zig
// FIXED: Changed from py*py*4.0 to py*py to resolve issue #793
// The original C++ code incorrectly used (py*2)², allowing connections at 4x walkableClimb
const thr = py * py;
```

### Документация

Добавлены комментарии в функцию `overlapSlabs`:
```zig
/// Check if two slabs overlap
///
/// NOTE: This function fixes a bug from the original C++ RecastNavigation (issue #793)
/// The original code incorrectly used (py*2)² as the threshold, which allowed connections
/// at 4x the walkableClimb distance. The corrected version uses py², which properly
/// limits connections to the agent's actual climbing ability.
```

## Валидация исправления

### Тестовые сценарии

1. **Критический сценарий:** Разница высот 2.0м > walkableClimb 1.8м
   - ДО исправления: `true` (неправильно разрешает)
   - ПОСЛЕ исправления: `false` (правильно запрещает)

2. **Граничный сценарий:** Разница высот = walkableClimb 1.8м
   - ДО исправления: `true`
   - ПОСЛЕ исправления: `true` (правильно разрешает)

3. **Запрещаемый сценарий:** Разница высот 2.5м > walkableClimb
   - ДО исправления: `true` (неправильно разрешает)
   - ПОСЛЕ исправления: `false` (правильно запрещает)

4. **Разрешаемый сценарий:** Разница высот 1.5м < walkableClimb
   - ДО исправления: `true`
   - ПОСЛЕ исправления: `true` (правильно разрешает)

### Результаты тестирования

```
=== ПРОВЕРКА ИСПРАВЛЕНИЯ OVERLAPSLABS ===

ТЕСТ 1: Критический сценарий (разница 2.0м > walkableClimb 1.8м)
  ✅ ПРАВИЛЬНО: Соединение запрещено

ТЕСТ 2: Граничный сценарий (ровно walkableClimb)
  ✅ ПРАВИЛЬНО: Соединение разрешено

ТЕСТ 3: Случай, который должен запрещаться
  ✅ ПРАВИЛЬНО: Соединение запрещено

ТЕСТ 4: Случай, который должен разрешаться
  ✅ ПРАВИЛЬНО: Соединение разрешено

=== ИТОГИ ТЕСТИРОВАНИЯ ===
✅ Все тесты пройдены!
✅ Функция overlapSlabs работает корректно!
✅ Проблема issue #793 исправлена в Zig-реализации!
```

## Влияние на pathfinding

### ДО исправления:
- ❌ Агенты выбирали пути, которые не могли пройти
- ❌ Некорректные соединения на границах tile
- ❌ Застревание в попытках пройти по недоступному маршруту

### ПОСЛЕ исправления:
- ✅ Агенты выбирают только проходимые маршруты
- ✅ Корректные соединения между полигонами
- ✅ Соответствие физическим возможностям агента

## Заключение

Проблема issue #793 полностью устранена в Zig-реализации RecastNavigation. Функция `overlapSlabs` теперь корректно обрабатывает соединения полигонов в соответствии с фактическими возможностями агента.

**Отличие от оригинального C++ кода:**
- C++ версия содержит ошибку (`py*2`)
- Zig версия исправлена (`py`)

Это исправление улучшает качество pathfinding и предотвращает выбор агентами непроходимых маршрутов.